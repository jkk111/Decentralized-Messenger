<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="improt" href="/bower_components/iron-icons/iron-icons.html">
<link rel="improt" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="contact-element.html">

<dom-module id="messenger-view">
  <style>
    paper-card {
      float:right;
    }
    paper-menu {
      padding-top: 0;
    }
    paper-dialog-scrollable {
      height:400px;
    }
    paper-toolbar {
      background-color: #4CAF50;
    };
  </style>
  <template>
    <iron-ajax id="pollajax" url="/messages" method="Post" content-type="application/x-www-form-urlencoded"
               body="{{messagesBody}}" handle-as="json" on-response="pollResponse">
               </iron-ajax>
    <iron-ajax id="friendsajax" url="/getFriends" method="Post" content-type="application/x-www-form-urlencoded"
               body="{{messagesBody}}" handle-as="json" on-response="friendsResponse">
               </iron-ajax>
    <iron-ajax id="messageAjax" url="/message" method="Post" content-type="application/x-www-form-urlencoded"
               body="{{messageBody}}" handle-as="json" on-response="messageSentResponse">
    </iron-ajax>
    <iron-ajax id="searchAjax" url="/search" method="POST" content-type="application/x-www-form-urlencoded"
               body="{{searchBody}}" handle-as="json" on-response="searchResultsReceived">
    </iron-ajax>
    <iron-ajax id="addFriendAjax" url="/addFriend" method="POST" content-type="application/x-www-form-urlencoded"
               body="{{addFriendBody}}" handle-as="json" on-response="friendAdded">
    </iron-ajax>
    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar>
          <div class="title">Friends</div>
        </paper-toolbar>
        <div id="drawerContent">
          <template is="dom-if" if="{{!showFriendSearch}}">
            <paper-button on-tap="toggleFriendSearch">
                <iron-icon icon="add"></iron-icon>
                add a friend
            </paper-button>
          </template>
          <template is="dom-if" if="{{showFriendSearch}}">
            <paper-item>
              <template is="dom-if" if="{{!hasFriendSearchResults}}">
                <paper-input placeholder="username" value="{{searchQuery}}">
                </paper-input>
                <paper-icon-button icon="search" title="search" on-tap="doSearch"></paper-icon-button>
              </template>
              <template is="dom-if" if="{{hasFriendSearchResults}}">
                <template is="dom-if" if="{{!friendSearchEmpty(friendSearchResults)}}">
                  <template is="dom-repeat" items="{{friendSearchResults}}">
                    <template is="dom-if" if="{{!isSelf(userId, item.id)}}">
                      <div userId="{{itemId}}">
                        <paper-item on-tap="addFriend" user-id="{{item.id}}">
                          {{item.username}}
                        </paper-item>
                      </div>
                    </template>
                  </template>
                </template>
                <template is="dom-if" if="{{friendSearchEmpty(friendSearchResults)}}">
                  <div>No Results</div>
                  <paper-button on-tap="returnToSearch">
                    Return
                  </paper-button>
                </template>
              </template>
              <paper-icon-button icon="close" title="close" on-tap="toggleFriendSearch"></paper-icon-button>
            </paper-item>
          </template>
          <paper-menu selected="{{selectedContact}}">
            <template is="dom-repeat" items="{{friends}}">
              <paper-item>
                <contact-element
                  name="{{item.username}}"
                  online="{{item.online}}"
                  img="{{item.img}}">
                </contact-element>
              </paper-item>
            </template>
          </paper-menu>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <div class="title">{{generateContactName(selectedContact)}}</div>
        </paper-toolbar>
        <div id="mainContent">
          <template is="dom-if" if="{{showWelcome}}">
            <template is="dom-if" if="{{noneSelected(selectedContact)}}">
              <div>
                <paper-card elevation="2" heading="A Decentralized Messenger" >
                  <div class="card-content">
                    Welcome To A Decentralized Messenger.
                    <br>Select a friend to view or send messages.
                    <br><br>Enjoy.
                  </div>
                  <div class="card-actions">
                    <paper-button on-tap="hideWelcome">Got it</paper-button>
                    <paper-button>FAQ</paper-button>
                    <paper-button>Contact</paper-button>
                  </div>
                </paper-card>
              </div>
            </template>
          </template>
          <div>
            <paper-dialog-scrollable id="messages">
              <div id="messagesContainer">
              <template is="dom-repeat" on-dom-change="scrollTest" items="{{currentMessages}}">
                  <div>{{item.message}}</div>
              </template>
            </div>
          </paper-dialog-scrollable>
            <template is="dom-if" if="{{!noneSelected(selectedContact)}}">
              <div>
                <paper-input on-keydown="checkSubmit" value="{{message}}" label="send a message"></paper-input>
              </div>
            </template>
          </div>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
      is: 'messenger-view',
      properties: {
        selectedContact: {
          type: Number,
          value: -1,
          notify: true
        },
        self: {
          type: Object
        },
        MAX_POLL_TIME: {
          type: Number,
          value: 5000 // 120 seconds
        },
        pollTime: {
          type: Number,
          value: 1000
        },
        polling: {
          type: Boolean,
          value: false
        },
        token: {
          type: String,
          value: "",
          observer: 'tokenChanged'
        },
        userId: {
          type: Number
        },
        friends: {
          type: Array,
          value: function() { return [] },
          notify: true
        },
        messages: {
          type: Array,
        },
        messagesBody: {
          type: Object,
          computed: 'computeMessagesBody(token, userId, highestReceived)'
        },
        messageBody: {
          type: Object,
          value: function() { return {}; }
        },
        highestReceived: {
          type: Number,
          value: 0
        },
        currentMessages: {
          type: Array,
          value: function() { return []; },
          notify: true
        },
        showFriendSearch: {
          type: Boolean,
          value: false
        },
        hasFriendSearchResults: {
          type: Boolean,
          value: false
        },
        searchQuery: {
          type: String,
          value: ""
        },
        searchBody: {
          type: Object,
          computed: 'computeSearchBody(userId, token, searchQuery)'
        },
        friendSearchResults: {
          type: Object,
          value: function() { return {}; }
        },
        showWelcome: {
          type: Boolean,
          value: true
        }
      },
      observers: [
        'friendsChanged(friends.*)',
        'friendsChanged(selectedContact)'
      ],
      computeSearchBody: function(id, token, searchQuery) {
        return { sender: id, token: token, query: searchQuery }
      },
      hideWelcome: function() {
        setCookie("showWelcome", false, 365);
        this.showWelcome = false;
      },
      friendSearchEmpty: function(results) {
        return !(results === undefined || results.users === undefined || results.users.length < 1 ||
                 results.users.length == 1 && this.isSelf(userId, results.users[0].id))
      },
      friendAdded: function(e, res) {
        if(!res || !res.results) {
          return;
        } else {
          console.log(res.results)
        }
      },
      isSelf: function(self, user) {
        return self == user;
      },
      addFriend: function(e) {
        var friendId = e.srcElement.userId;
        this.set("addFriendBody", this.computeAddFriendBody(this.userId, this.token, friendId, "lol"));
        this.$.addFriendAjax.generateRequest();
      },
      computeAddFriendBody: function(id, token, friend, secret) {
        return { sender: id, token: token, client: friend, secret: secret };
      },
      friendsChanged: function(cr) {
        console.log(cr);
        this.set("currentMessages", this.computeCurrentMessages(this.selectedContact, this.friends));
        this.notifyPath("currentMessages", this.currentMessages.slice());
      },
      computeCurrentMessages: function(i, friends) {
        if(friends && i > friends.length || i == -1)
          return [];
        return friends[i].messages
      },
      scrollTest: function() {
        console.log("it works")
        this.$.messagesContainer.scrollTop = this.$.messagesContainer.scrollHeight + 10000;
      },
      doSearch: function() {
        this.$.searchAjax.generateRequest();
      },
      tokenChanged: function(newValue, old) {
        if(newValue != "") {
          this.loggedIn();
          console.log(this);
          console.log("Polling for updates");
          console.log(this.messagesBody);
          console.log(this);
          this.$.friendsajax.generateRequest();
          if(!this.polling) {
            console.log("polling")
            this.polling = true;
            this.$.pollajax.generateRequest();
          }
        }
      },
      searchResultsReceived: function(e, res) {
        if(!res || !res.response || !res.response.users) {
          return;
        } else {
          this.set("friendSearchResults", res.response.users);
          this.hasFriendSearchResults = true;
        }
        console.log(res.response);
      },
      computeMessagesBody: function(token, id, h) {
        console.log(token + ":" + id);
        console.log(this.highestReceived)
        console.log(token + "\n" + id + "\n" + this.highestReceived)
        return { token: token, sender: id, highestReceived: this.highestReceived };
      },
      getMessages: function(friends, contact) {
        if(!friends || contact > friends.length || contact == -1)
          return
        return friends[contact].messages;
      },
      getSelectedFriend: function(contact) {
        return this.friends[contact]
      },
      generateContactName: function(friend) {
        console.log(friend);
        if(friend < 0)
          return "";
        return this.getSelectedFriend(friend).name;
      },
      noneSelected: function(friend) {
        if (friend < 0)
          return true;
        return false;
      },
      pollResponse: function(e, res) {
        if(this.containsError(res.response)) {
          return;
        }
        console.log(res.response);
        var asString;
        try {
          asString = JSON.stringify(res.response);
        } catch(e) {
          asString = "{}";
        }
        if(asString == "{}") {
          console.log("Increasing wait time");
          this.pollTime = Math.min(this.pollTime * 2, this.MAX_POLL_TIME)
        } else {
          console.log("Resetting wait time");
          this.pollTime = 1000;
          this.addMessagesToFriends(res.response);
        }
        var self = this;
        setTimeout(function() {
          self.$.pollajax.generateRequest();
        }, this.pollTime)
      },
      addMessagesToFriends: function(messages) {
        var ids = Object.keys(messages);
        for(var i = 0 ; i < ids.length; i++) {
          for(var j = 0 ; j < this.friends.length; j++) {
            if(ids[i] ==  this.friends[j].id) {
              if(!this.friends[j].messages)
                this.friends[j].messages = [];
              for(var k = 0; k < messages[ids[i]].length; k++) {
                console.log(messages[ids[i]][k].id)
                if(messages[ids[i]][k].id > this.highestReceived || this.highestReceived == NaN || this.highestReceived === undefined) {
                  console.log("changing highestReceived")
                  this.set("highestReceived", messages[ids[i]][k].id);
                } else {
                  console.log("not pushing %d, %d", this.highestReceived, messages[ids[i]][k].id);
                  console.log(this.highestReceived)
                }
                // this.friends[j].messages.push(messages[ids[i]][k])
                console.log("friends."+j+".messages");
                this.push("friends." + j + ".messages", messages[ids[i]][k]);
                this.notifyPath("friends", this.friends.slice());
                this.notifyPath("friends."+j+".messages", this.friends[j].messages.slice());
              }
            }
          }
        }
      },
      checkSubmit: function(e) {
        if(e.keyCode == 13) {
          this.messageBody = this.computeMessageBody()
          this.message = "";
          this.$.messageAjax.generateRequest();
        }
      },
      computeMessageBody: function() {
        console.log({ sender: this.userId, dest: this.friends[this.selectedContact].id, message: this.message, token: this.token });
        return { sender: this.userId, dest: this.friends[this.selectedContact].id, message: this.message, token: this.token }
      },
      friendsResponse: function(e, res) {
        if(res.response) {
          var tmp = res.response;
          console.log(tmp);
          this.friends = tmp;
        }
      },
      loggedIn: function() {
        // this.$.pollajax.generateRequest();
      },
      toggleFriendSearch: function() {
        this.showFriendSearch = !this.showFriendSearch;
        this.searchQuery = "";
        this.set("friendSearchResults", {});
        this.hasFriendSearchResults = false;
      },

      containsError: function(e) {
        if(e && e.error) {
          errorHandler(e);
          return true;
        } else {
          return false;
        }
      },
      errorHandler: function(e) {
        switch(e.error) {
          case "ERROR_BAD_TOKEN":
            this.fire("relogin");
        }
      },
      attached: function() {
        this.setVisibilityOfWelcome();
      },
      setVisibilityOfWelcome: function() {
        var show = getCookie("showWelcome");
        if(show !== undefined) {
          this.showWelcome = false;
        } else {
          this.showWelcome = true;
        }
      }
    })
    function getCookie(cname) {
      var name = cname + "=";
      var ca = document.cookie.split(';');
      for(var i=0; i<ca.length; i++) {
          var c = ca[i];
          while (c.charAt(0)==' ') c = c.substring(1);
          if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
      }
      return undefined;
    }
    function setCookie(cname, cvalue, exdays) {
      var d = new Date();
      d.setTime(d.getTime() + (exdays*24*60*60*1000));
      var expires = "expires="+d.toUTCString();
      document.cookie = cname + "=" + cvalue + "; " + expires;
    }
  </script>
</dom-module>
