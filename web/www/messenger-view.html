<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="/bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/paper-material/paper-material.html">
<link rel="import" href="/bower_components/paper-input/paper-textarea.html">
<link re;="import" href="/bower_components/iron-pages/iron-pages/html">
<link rel="improt" href="/bower_components/iron-icons/iron-icons.html">
<link rel="improt" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="contact-element.html">

<dom-module id="messenger-view">
  <style>
    paper-menu {
      padding-top: 0;
    }
    paper-dialog-scrollable {
      height:400px;
    }
    paper-toolbar {
      background-color: #4CAF50;
    };
  </style>
  <template>
    <iron-ajax id="pollajax" url="/messages" method="Post" content-type="application/x-www-form-urlencoded"
               body="{{messagesBody}}" handle-as="json" on-response="pollResponse">
    </iron-ajax>
    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar>
          <div class="title">Friends</div>
        </paper-toolbar>
        <div id="drawerContent">
          <paper-menu selected="{{selectedContact}}">
            <template is="dom-repeat" items="{{friends}}">
              <paper-item>
                <contact-element
                  name="{{item.name}}"
                  online="{{item.online}}"
                  img="{{item.img}}">
                </contact-element>
              </paper-item>
            </template>
          </paper-menu>
        </div>
      </paper-header-panel>
      <paper-header-panel main>
        <paper-toolbar>
          <div class="title">{{generateContactName(selectedContact)}}</div>
        </paper-toolbar>
        <div id="mainContent">
          <template is="dom-if" if="{{noneSelected(selectedContact)}}">
            <div>
              <paper-material>
                  Choose a contact to view or send messages.
              </paper-material>
            </div>
          </template>
          <div>
            <paper-dialog-scrollable>
            <template is="dom-repeat" items="{{getMessages(selectedContact)}}">
              <paper-item>{{item}}</paper-item>
            </template>
          </paper-dialog-scrollable>
            <template is="dom-if" if="{{!noneSelected(selectedContact)}}">
              <div>
                <paper-textarea label="send a message"></paper-textarea>
              </div>
            </template>
          </div>
        </div>
      </paper-header-panel>
    </paper-drawer-panel>
  </template>
  <script>
    Polymer({
      is: 'messenger-view',
      properties: {
        selectedContact: {
          type: Number,
          value: -1,
          notify: true
        },
        self: {
          type: Object
        },
        MAX_POLL_TIME: {
          type: Number,
          value: 120000 // 120 seconds
        },
        pollTime: {
          type: Number,
          value: 1000
        },
        token: {
          type: String,
          value: "",
          observer: 'tokenChanged'
        },
        userId: {
          type: Number
        },
        friends: {
          type: Array,
          value: [
            {
              name: "Mr. One",
              online: true,
              img: "img/one.png"
            },{
              name: "Mr. Two",
              online: true,
              img: "img/two.png"
            },{
              name: "Mr. Three",
              online: false,
              img: "img/three.png"
            }
          ]
        },
        messages: {
          type: Array,
        },
        messagesBody: {
          type: Object,
          computed: 'computeMessagesBody(token, userId)'
        }
      },
      tokenChanged: function(newValue, old) {
        if(newValue != "") {
          this.loggedIn();
          console.log(this);
          console.log("Polling for updates");
          console.log(this.messagesBody);
          console.log(this);
          this.$.pollajax.generateRequest();
        }
      },

      computeMessagesBody: function(id, token) {
        console.log(token + ":" + id);
        return { token: token, sender: id };
      },
      getMessages: function(contact) {
        if(!this.messages || contact > this.messages.length || contact == -1)
          return
        return this.messages[contact];
      },
      getSelectedFriend: function(contact) {
        return this.friends[contact]
      },
      generateContactName: function(friend) {
        console.log(friend);
        if(friend < 0)
          return "";
        return this.getSelectedFriend(friend).name;
      },
      noneSelected: function(friend) {
        if (friend < 0)
          return true;
        return false;
      },
      pollResponse: function(e, res) {
        console.log(e.res);
        if(res.reponse == {}) {
          this.pollTime = Math.min(this.pollTime * 2, this.MAX_POLL_TIME)
        } else {
          this.pollTime = 1000;
        }
        setTimeout(this.poll, this.pollTime)
      },
      loggedIn: function() {
        this.poll();
      },
      poll: function() {
      }
    })
  </script>
</dom-module>
